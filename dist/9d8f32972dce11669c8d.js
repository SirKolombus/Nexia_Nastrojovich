function restartTool(){yearDataStore={y3:null,y2:null,y1:null,y0:null},evaluationResults=null,selectedStartCell=null;const e=(new Date).getFullYear();document.getElementById("accounting-period-start").value=`${e}-01-01`,document.getElementById("unit-name").value="",document.getElementById("unit-ico").value="",document.getElementById("unit-type").value="",updateYearLabels(),updateButtonStates(),document.getElementById("data-summary").classList.add("hidden"),document.getElementById("results-section").classList.add("hidden"),document.getElementById("print-section").classList.add("hidden"),document.getElementById("print-preview").classList.add("hidden"),showNotification("Kontrola byla restartována","success")}import{showNotification,formatNumber}from"../shared/utils.js";let evaluationResults=null,yearDataStore={y3:null,y2:null,y1:null,y0:null},currentEditingYear=null,selectedStartCell=null;function initialize(){document.getElementById("btn-back-launcher").onclick=()=>{window.location.href="launcher.html"},document.getElementById("btn-restart").onclick=restartTool,document.getElementById("btn-evaluate").onclick=evaluateData,document.getElementById("btn-select-cell").onclick=selectCellForPrint,document.getElementById("btn-print").onclick=printParameters;const e=document.getElementById("accounting-period-start");if(e){e.addEventListener("change",updateYearLabels);const t=(new Date).getFullYear();e.value||(e.value=`${t}-01-01`),updateYearLabels()}document.getElementById("btn-year-3").onclick=()=>openYearModal("y3"),document.getElementById("btn-year-2").onclick=()=>openYearModal("y2"),document.getElementById("btn-year-1").onclick=()=>openYearModal("y1"),document.getElementById("btn-year-0").onclick=()=>openYearModal("y0"),document.getElementById("modal-close").onclick=closeYearModal,document.getElementById("modal-cancel").onclick=closeYearModal,document.getElementById("modal-save").onclick=saveYearData,document.getElementById("year-modal").onclick=e=>{"year-modal"===e.target.id&&closeYearModal()},setupNumberFormatting()}function setupNumberFormatting(){document.querySelectorAll(".formatted-number").forEach(e=>{e.addEventListener("input",function(e){let t=e.target.value.replace(/\s/g,"");t=t.replace(/\D/g,""),e.target.value=t?formatNumberWithSpaces(parseInt(t)):""}),e.addEventListener("blur",function(e){let t=e.target.value.replace(/\s/g,"");t&&!isNaN(t)&&(e.target.value=formatNumberWithSpaces(parseInt(t)))})})}function formatNumberWithSpaces(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function formatDateCz(e){if(!e)return"";const[t,a,n]=e.split("-").map(e=>parseInt(e,10));return t&&a&&n?`${n}.${a}.${t}`:e}function updateYearLabels(){const e=document.getElementById("accounting-period-start");if(!e||!e.value)return;const[t,a,n]=e.value.split("-").map(e=>parseInt(e,10));if(!t)return;const o=1===a&&1===n?"Rok ":"FY";document.getElementById("year-label-3").textContent=`${o}${t-3}`,document.getElementById("year-label-2").textContent=`${o}${t-2}`,document.getElementById("year-label-1").textContent=`${o}${t-1}`,document.getElementById("year-label-0").textContent=`${o}${t}`,yearDataStore={y3:null,y2:null,y1:null,y0:null},updateButtonStates(),updateDataSummary()}function openYearModal(e){currentEditingYear=e;const t=document.getElementById("accounting-period-start");if(!t||!t.value)return void showNotification("Nejprve vyplňte první den účetního období","warning");const[a]=t.value.split("-").map(e=>parseInt(e,10));let n;if(n="y3"===e?a-3:"y2"===e?a-2:"y1"===e?a-1:a,document.getElementById("modal-year-title").textContent=`Vyplnit údaje pro rok ${n}`,yearDataStore[e]){const t=yearDataStore[e];document.getElementById("modal-aktiva").value=t.aktiva?formatNumberWithSpaces(t.aktiva):"",document.getElementById("modal-obrat").value=t.obrat?formatNumberWithSpaces(t.obrat):"",document.getElementById("modal-zamestnanci").value=t.zamestnanci?formatNumberWithSpaces(t.zamestnanci):"",document.getElementById("modal-zdroj").value=t.zdroj||""}else document.getElementById("modal-aktiva").value="",document.getElementById("modal-obrat").value="",document.getElementById("modal-zamestnanci").value="",document.getElementById("modal-zdroj").value="";document.getElementById("year-modal").classList.remove("hidden")}function closeYearModal(){document.getElementById("year-modal").classList.add("hidden"),currentEditingYear=null}function saveYearData(){if(!currentEditingYear)return;const e=document.getElementById("modal-aktiva").value.replace(/\s/g,""),t=document.getElementById("modal-obrat").value.replace(/\s/g,""),a=document.getElementById("modal-zamestnanci").value.replace(/\s/g,""),n=parseFloat(e)||0,o=parseFloat(t)||0,r=parseFloat(a)||0,l=document.getElementById("modal-zdroj").value.trim();0!==n||0!==o||0!==r?l?(yearDataStore[currentEditingYear]={aktiva:n,obrat:o,zamestnanci:r,zdroj:l},updateButtonStates(),updateDataSummary(),closeYearModal(),showNotification("Údaje byly úspěšně uloženy","success")):showNotification("Prosím vyplňte zdroj dat","warning"):showNotification("Prosím vyplňte alespoň jeden údaj","warning")}function updateButtonStates(){["y3","y2","y1","y0"].forEach((e,t)=>{const a=document.getElementById("btn-year-"+(3-t)),n=document.getElementById("year-status-"+(3-t));a&&n&&(yearDataStore[e]?(a.classList.add("filled"),n.textContent="✓ Vyplněno"):(a.classList.remove("filled"),n.textContent="Nevyplněno"))})}function updateDataSummary(){const e=document.getElementById("accounting-period-start");if(!e||!e.value)return;const[t]=e.value.split("-").map(e=>parseInt(e,10));if(!(yearDataStore.y3||yearDataStore.y2||yearDataStore.y1||yearDataStore.y0))return void document.getElementById("data-summary").classList.add("hidden");let a="";[{key:"y3",year:t-3},{key:"y2",year:t-2},{key:"y1",year:t-1},{key:"y0",year:t}].forEach(({key:e,year:t})=>{if(yearDataStore[e]){const n=yearDataStore[e];a+=`\n        <div class="summary-item">\n          <div class="summary-year">Rok ${t}:</div>\n          <div class="summary-values">\n            Aktiva: ${formatNumber(n.aktiva,0)} Kč | \n            Obrat: ${formatNumber(n.obrat,0)} Kč | \n            Zaměstnanci: ${formatNumber(n.zamestnanci,0)}<br>\n            <small><em>Zdroj: ${n.zdroj}</em></small>\n          </div>\n        </div>\n      `}}),document.getElementById("summary-content").innerHTML=a,document.getElementById("data-summary").classList.remove("hidden")}function getFormValues(){const e=document.getElementById("accounting-period-start").value,t=document.getElementById("unit-name").value.trim(),a=document.getElementById("unit-type").value,n=document.getElementById("unit-ico").value.trim();let o=(new Date).getFullYear();return e&&([o]=e.split("-").map(e=>parseInt(e,10))),{unitName:t,unitType:a,unitICO:n,accountingPeriodStart:e,years:{y3:o-3,y2:o-2,y1:o-1,y0:o},aktiva:{y3:yearDataStore.y3?yearDataStore.y3.aktiva:0,y2:yearDataStore.y2?yearDataStore.y2.aktiva:0,y1:yearDataStore.y1?yearDataStore.y1.aktiva:0,y0:yearDataStore.y0?yearDataStore.y0.aktiva:0},obrat:{y3:yearDataStore.y3?yearDataStore.y3.obrat:0,y2:yearDataStore.y2?yearDataStore.y2.obrat:0,y1:yearDataStore.y1?yearDataStore.y1.obrat:0,y0:yearDataStore.y0?yearDataStore.y0.obrat:0},zamestnanci:{y3:yearDataStore.y3?yearDataStore.y3.zamestnanci:0,y2:yearDataStore.y2?yearDataStore.y2.zamestnanci:0,y1:yearDataStore.y1?yearDataStore.y1.zamestnanci:0,y0:yearDataStore.y0?yearDataStore.y0.zamestnanci:0},zdroje:{y3:yearDataStore.y3?yearDataStore.y3.zdroj:"",y2:yearDataStore.y2?yearDataStore.y2.zdroj:"",y1:yearDataStore.y1?yearDataStore.y1.zdroj:"",y0:yearDataStore.y0?yearDataStore.y0.zdroj:""}}}function validateData(e){return e.unitName&&e.unitType&&e.unitICO?e.accountingPeriodStart?!!(yearDataStore.y3||yearDataStore.y2||yearDataStore.y1||yearDataStore.y0)||(showNotification("Prosím vyplňte údaje alespoň pro jeden rok","error"),!1):(showNotification("Prosím vyplňte první den účetního období","error"),!1):(showNotification("Vyplňte prosím název, typ a IČO účetní jednotky","error"),!1)}function evaluateData(){const e=getFormValues();if(!validateData(e))return;const t={micro:{aktiva:9e3,obrat:18e3,zamestnanci:10},small:{aktiva:1e5,obrat:2e5,zamestnanci:50},medium:{aktiva:5e5,obrat:1e6,zamestnanci:250}},a={micro:{aktiva:11e3,obrat:22e3,zamestnanci:10},small:{aktiva:12e4,obrat:24e4,zamestnanci:50},medium:{aktiva:6e5,obrat:12e5,zamestnanci:250}};function n(e,n,o,r){if(null==e&&null==n&&null==o)return null;const l=r>=2024?a:t,s="number"==typeof e?e/1e3:0,i="number"==typeof n?n/1e3:0,y="number"==typeof o?o:0;let c;return c=0,s>=l.micro.aktiva&&c++,i>=l.micro.obrat&&c++,y>=l.micro.zamestnanci&&c++,c<2?"Mikro účetní jednotka":(c=0,s>=l.small.aktiva&&c++,i>=l.small.obrat&&c++,y>=l.small.zamestnanci&&c++,c<2?"Malá účetní jednotka":(c=0,s>=l.medium.aktiva&&c++,i>=l.medium.obrat&&c++,y>=l.medium.zamestnanci&&c++,c<2?"Střední účetní jednotka":"Velká účetní jednotka"))}const o={y3:yearDataStore.y3?n(e.aktiva.y3,e.obrat.y3,e.zamestnanci.y3,e.years.y3):null,y2:yearDataStore.y2?n(e.aktiva.y2,e.obrat.y2,e.zamestnanci.y2,e.years.y2):null,y1:yearDataStore.y1?n(e.aktiva.y1,e.obrat.y1,e.zamestnanci.y1,e.years.y1):null,y0:yearDataStore.y0?n(e.aktiva.y0,e.obrat.y0,e.zamestnanci.y0,e.years.y0):null},r=new Date(e.accountingPeriodStart)<new Date("2024-01-01");evaluationResults={data:e,categories:o,thresholdVersion:r?"do 31.12.2023":"od 1.1.2024",thresholds:r?t:a},displayResults(evaluationResults),showNotification("Údaje byly úspěšně vyhodnoceny","success")}function getOfficialCategory(e){const t=["y3","y2","y1","y0"];if(0===t.map(t=>e[t]).filter(Boolean).length)return"Nedostatek dat";if(e.y2&&e.y1&&e.y2===e.y1)return e.y1;if(e.y3&&e.y2&&e.y3===e.y2)return e.y2;for(let a=0;a<t.length;a++)if(e[t[a]])return e[t[a]];return"Nedostatek dat"}function evaluateAuditObligation(e){const t={aktiva:4e7,obrat:8e7,zamestnanci:50},a={aktiva:12e7,obrat:24e7,zamestnanci:50},n=["Akciová společnost","Svěřenský fond"],o={};return["y3","y2","y1","y0"].forEach(r=>{const l=e.years[r]>=2026?a:t;let s=0;e.aktiva[r]>=l.aktiva&&s++,e.obrat[r]>=l.obrat&&s++,e.zamestnanci[r]>=l.zamestnanci&&s++,n.includes(e.unitType)?o[r]=s>=1?"ANO":"NE":o[r]=s>=2?"ANO":"NE"}),o}function getOfficialAuditObligation(e,t,a){return"Malá účetní jednotka"===getOfficialCategory(t)?"NE":e.y0&&e.y1&&e.y0===e.y1?e.y0:e.y1&&e.y2&&e.y1===e.y2?e.y1:e.y2&&e.y3&&e.y2===e.y3?e.y2:e.y3?e.y3:e.y0||"Nedostatek dat"}function getCategory2024OrLater(e,t){const a=["y3","y2","y1","y0"];for(const n of a)if(t.years[n]>=2024&&e[n])return e[n];return null}function displayResults(e){const t=evaluateAuditObligation(e.data),a=getOfficialAuditObligation(t,e.categories,e.data),n=`\n    <div class="result-item">\n      <span class="result-label">První den účetního období:</span>\n      <span class="result-value">${formatDateCz(e.data.accountingPeriodStart)}</span>\n    </div>\n    <div class="result-item">\n      <span class="result-label">Použité limity:</span>\n      <span class="result-value">${e.thresholdVersion}</span>\n    </div>\n    <div class="result-item">\n      <span class="result-label">Rok ${e.data.years.y3}:</span>\n      <span class="result-value result-success">${e.categories.y3??"—"}</span>\n      <span class="result-label ml-12">Audit:</span>\n      <span class="result-value">${t.y3}</span>\n    </div>\n    <div class="result-item">\n      <span class="result-label">Rok ${e.data.years.y2}:</span>\n      <span class="result-value result-success">${e.categories.y2??"—"}</span>\n      <span class="result-label ml-12">Audit:</span>\n      <span class="result-value">${t.y2}</span>\n    </div>\n    <div class="result-item">\n      <span class="result-label">Rok ${e.data.years.y1}:</span>\n      <span class="result-value result-success">${e.categories.y1??"—"}</span>\n      <span class="result-label ml-12">Audit:</span>\n      <span class="result-value">${t.y1}</span>\n    </div>\n    <div class="result-item">\n      <span class="result-label">Rok ${e.data.years.y0}:</span>\n      <span class="result-value result-success">${e.categories.y0??"—"}</span>\n      <span class="result-label ml-12">Audit:</span>\n      <span class="result-value">${t.y0}</span>\n    </div>\n        <div class="result-item result-official">\n      <span class="result-label">Pro kontrolovaný rok účetní jednotka je vnímána za:</span>\n      <span class="result-value result-success">${getOfficialCategory(e.categories)}</span>\n    </div>\n    <div class="result-item result-official">\n      <span class="result-label">Pro kontrolovaný rok účetní jednotka je povinna k auditu?:</span>\n      <span class="result-value result-success">${a}</span>\n    </div>\n  `;document.getElementById("results-content").innerHTML=n,document.getElementById("results-section").classList.remove("hidden"),document.getElementById("print-section").classList.remove("hidden")}async function selectCellForPrint(){if(evaluationResults)try{await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.load("address, rowIndex, columnIndex"),await e.sync(),selectedStartCell={address:t.address,rowIndex:t.rowIndex,columnIndex:t.columnIndex};const a=selectedStartCell.rowIndex+31-1,n=selectedStartCell.columnIndex+5-1,o=getColumnLetter(selectedStartCell.columnIndex),r=getColumnLetter(n),l=`${o}${selectedStartCell.rowIndex+1}:${r}${a+1}`;document.getElementById("print-range-text").textContent=l,document.getElementById("print-preview").classList.remove("hidden"),showNotification("Buňka vybrána: "+selectedStartCell.address,"success")})}catch(e){console.error("Error selecting cell:",e),showNotification("Chyba při výběru buňky: "+e.message,"error")}else showNotification("Nejprve vyhodnoťte údaje","warning")}function getColumnLetter(e){let t="",a=e;for(;a>=0;)t=String.fromCharCode(65+a%26)+t,a=Math.floor(a/26)-1;return t}async function printParameters(){if(evaluationResults)if(selectedStartCell)try{await Excel.run(async e=>{const t=e.workbook.worksheets.getActiveWorksheet(),a=evaluationResults.data,n=evaluateAuditObligation(a),o=getOfficialAuditObligation(n,evaluationResults.categories,a),r=[["PROVĚRKA KLIENTA - PARAMETRY","","","",""],["","","","",""],["První den účetního období:",formatDateCz(a.accountingPeriodStart),"","",""],["Použité limity:",evaluationResults.thresholdVersion,"","",""],["","","","",""],["FINANČNÍ ÚDAJE","","","",""],["",a.years.y3,a.years.y2,a.years.y1,a.years.y0],["Aktiva (Kč)",a.aktiva.y3,a.aktiva.y2,a.aktiva.y1,a.aktiva.y0],["Obrat (Kč)",a.obrat.y3,a.obrat.y2,a.obrat.y1,a.obrat.y0],["Průměrný počet zaměstnanců",a.zamestnanci.y3,a.zamestnanci.y2,a.zamestnanci.y1,a.zamestnanci.y0],["","","","",""],["ZDROJE DAT","","","",""],[`Rok ${a.years.y3}:`,a.zdroje.y3||"N/A","","",""],[`Rok ${a.years.y2}:`,a.zdroje.y2||"N/A","","",""],[`Rok ${a.years.y1}:`,a.zdroje.y1||"N/A","","",""],[`Rok ${a.years.y0}:`,a.zdroje.y0||"N/A","","",""],["","","","",""],["VYHODNOCENÍ (kategorie dle roku)","Velikost účetní jednotky","Povinnost auditu:","",""],["Rok "+a.years.y3+":",evaluationResults.categories.y3||"—",n.y3,"",""],["Rok "+a.years.y2+":",evaluationResults.categories.y2||"—",n.y2,"",""],["Rok "+a.years.y1+":",evaluationResults.categories.y1||"—",n.y1,"",""],["Rok "+a.years.y0+":",evaluationResults.categories.y0||"—",n.y0,"",""],["","","","",""],["Datum vytvoření:",(new Date).toLocaleString("cs-CZ"),"","",""]];r.push(["","","","",""]),r.push(["Pro kontrolovaný rok účetní jednotka je vnímána za:",getOfficialCategory(evaluationResults.categories),o,"",""]),r.unshift(["","","","",""]),r.unshift(["KONTROLOVANÁ ÚČETNÍ JEDNOTKA","","","",""]),r.unshift(["Typ:",a.unitType,"","",""]),r.unshift(["IČO:",a.unitICO,"","",""]),r.unshift(["Název:",a.unitName,"","",""]);const l=selectedStartCell.rowIndex,s=selectedStartCell.columnIndex,i=t.getRangeByIndexes(l,s,r.length,5);i.values=r;const y=t.getRangeByIndexes(l+3,s,1,2);y.format.font.bold=!0,y.format.fill.color="#e0e0e0";const c=t.getRangeByIndexes(l+5,s,1,5);c.format.font.bold=!0,c.format.font.size=14,c.format.fill.color="#1CB5A6",c.format.font.color="white";const u=t.getRangeByIndexes(l+10,s,1,5);u.format.font.bold=!0,u.format.font.size=14,u.format.fill.color="#1CB5A6",u.format.font.color="white";const d=t.getRangeByIndexes(l+16,s,1,5);d.format.font.bold=!0,d.format.font.size=14,d.format.fill.color="#1CB5A6",d.format.font.color="white";const m=t.getRangeByIndexes(l+22,s,1,3);m.format.font.bold=!0,m.format.font.size=14,m.format.fill.color="#1CB5A6",m.format.font.color="white";const v=t.getRangeByIndexes(l+11,s,1,5);v.format.font.bold=!0,v.format.fill.color="#e0e0e0",t.getRangeByIndexes(l+12,s+1,1,4).numberFormat=[["#,##0"]],t.getRangeByIndexes(l+13,s+1,1,4).numberFormat=[["#,##0"]],t.getRangeByIndexes(l+14,s+1,1,4).numberFormat=[["#,##0"]],i.format.autofitColumns(),await e.sync(),showNotification("Parametry byly úspěšně vytištěny do listu","success")})}catch(e){console.error("Error printing parameters:",e),showNotification("Chyba při tisku parametrů: "+e.message,"error")}else showNotification("Nejprve vyberte buňku pro tisk","warning");else showNotification("Nejprve vyhodnoťte údaje","warning")}Office.onReady(e=>{e.host===Office.HostType.Excel&&(document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").classList.remove("hidden"),initialize())});